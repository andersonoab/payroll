<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Igarapé Digital | Validação de Folha por Verba (6 Sigma)</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="wrap">
      <div class="topbar-inner">
        <div class="brand">
          <div class="brand-title">Validação de Folha por Verba</div>
          <div class="brand-sub">6 Sigma | Igarapé Digital</div>
        </div>

        <div class="actions">
          <label class="btn secondary" for="fileInput" title="Importa um arquivo Excel (.xlsx) e armazena os dados localmente (localStorage).">Importar Excel</label>
          <input id="fileInput" type="file" accept=".xlsx,.xls" />
          <button id="btnExportTxt" class="btn secondary" type="button" title="Exporta a visão agregada (conforme filtros atuais) em TXT.">Exportar TXT</button>
          <button id="btnExportXlsx" class="btn secondary" type="button" title="Exporta a visão agregada (conforme filtros atuais) em Excel.">Exportar Excel</button>
          <button id="btnClear" class="btn danger" type="button" title="Remove os dados armazenados localmente e reinicia o app.">Limpar storage</button>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <main>
      <section class="card">
        <div class="card-head">
          <div>
            <h2>Filtros e parâmetros</h2>
            <p id="dataInfo">Importe um Excel para analisar variação mensal por verba usando 6 Sigma.</p>
          </div>
          <div style="text-align:right;">
            <p id="tableInfo"></p>
          </div>
        </div>

        <div class="filters">
          <div class="field">
            <label for="fSearch" title="Busca livre em código, descrição, grupo e colunas extras selecionadas.">Busca</label>
            <div class="inputwrap">
              <input id="fSearch" type="text" placeholder="Digite para filtrar..." />
              <button id="btnClearSearch" class="clearbtn" type="button">X</button>
            </div>
          </div>

          <div class="field">
            <label for="fVerba" title="Selecione a verba (Código - Descrição).">Verba (Código - Descrição)</label>
            <select id="fVerba"></select>
          </div>

          <div class="field">
            <label for="fMetric" title="Escolha qual métrica mensal será usada na análise (ex.: Valor, Hora).">Métrica mensal</label>
            <select id="fMetric"></select>
          </div>

          <div class="field">
            <label for="fRefMonth" title="Mês usado como referência para comparar contra a estatística do histórico.">Mês de referência</label>
            <select id="fRefMonth"></select>
          </div>

          <div class="field">
            <label for="fWindow" title="Número de meses anteriores usados para calcular μ e σ. Se vazio, usa todo o histórico disponível.">Janela histórica (meses)</label>
            <div class="inputwrap">
              <input id="fWindow" type="number" min="2" step="1" placeholder="Ex.: 6" />
              <button id="btnClearWindow" class="clearbtn" type="button">X</button>
            </div>
          </div>

          <div class="field">
            <label for="fIgnoreZeros" title="Se ativo, meses com valor 0 não entram no cálculo da média e do desvio padrão.">Ignorar zeros no histórico</label>
            <select id="fIgnoreZeros">
              <option value="0">Não</option>
              <option value="1">Sim</option>
            </select>
          </div>

          <div class="field">
            <label for="fStatus" title="Filtra o resultado final pelo status calculado a partir do Z-score.">Status</label>
            <select id="fStatus"></select>
          </div>

          <div class="field">
            <label for="fMinZ" title="Z mínimo (opcional). Útil para ver apenas desvios relevantes.">Z mínimo</label>
            <div class="inputwrap">
              <input id="fMinZ" type="number" step="0.01" placeholder="Ex.: -2" />
              <button id="btnClearMinZ" class="clearbtn" type="button">X</button>
            </div>
          </div>

          <div class="field">
            <label for="fMaxZ" title="Z máximo (opcional).">Z máximo</label>
            <div class="inputwrap">
              <input id="fMaxZ" type="number" step="0.01" placeholder="Ex.: 3" />
              <button id="btnClearMaxZ" class="clearbtn" type="button">X</button>
            </div>
          </div>
        </div>

        <div class="filters-actions">
          <button id="btnApply" class="btn" type="button" title="Reaplica filtros e recalcula agregações/estatísticas.">Aplicar</button>
          <button id="btnReset" class="btn secondary" type="button" title="Limpa filtros e parâmetros (não apaga o storage).">Resetar</button>
        </div>

        <div class="grid2">
          <div class="card mini">
            <div class="mini-title" title="Quantidade de grupos (verba + agrupamento) na visão atual.">Total</div>
            <div id="kpiTotal" class="mini-value">0</div>
          </div>
          <div class="card mini">
            <div class="mini-title" title="Grupos com |Z| ≤ 2.">Aceitável</div>
            <div id="kpiOk" class="mini-value">0</div>
          </div>
          <div class="card mini">
            <div class="mini-title" title="Grupos com 2 < |Z| ≤ 3.">Alerta</div>
            <div id="kpiWarn" class="mini-value">0</div>
          </div>
          <div class="card mini">
            <div class="mini-title" title="Grupos com |Z| > 3.">Fora</div>
            <div id="kpiOut" class="mini-value">0</div>
          </div>
          <div class="card mini">
            <div class="mini-title" title="Média dos Z-scores (somente onde há histórico).">Z médio</div>
            <div id="kpiAvgZ" class="mini-value">0,00</div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-head">
          <div>
            <h2>Colunas extras (filtros e exibição)</h2>
            <p>Marque colunas para criar filtros dinâmicos e/ou exibir no grid. Ao adicionar novas colunas no Excel, elas aparecerão aqui automaticamente.</p>
          </div>
        </div>

        <div class="split">
          <div>
            <h3 class="subhead">Selecionar colunas</h3>
            <div id="colPickerBody" class="picker"></div>
          </div>
          <div>
            <h3 class="subhead">Agrupar por</h3>
            <p class="hint">O agrupamento define o nível do comparador (ex.: por Estabelecimento + Centro de Custo). Clique para marcar/desmarcar.</p>
            <div id="groupPickerBody" class="picker"></div>
          </div>
        </div>

        <div>
          <h3 class="subhead">Filtros extras</h3>
          <div id="extraFilters" class="filters"></div>
        </div>
      </section>

      <section class="card">
        <div class="card-head">
          <div>
            <h2>Comparador mensal (grid)</h2>
            <p title="Faixa 6σ: média ± 3σ. Camadas em ±1σ, ±2σ, ±3σ. O marcador representa o valor do mês de referência.">Faixa: média ± 3σ (largura total = 6σ). Linhas em ±1σ, ±2σ, ±3σ. Marcador no mês de referência.</p>
          </div>
        </div>

        
        <div id="monthTotals" class="monthtotals" aria-label="Totais por mês"></div>

        <div class="tablebox">
          <div class="tablewrap">
            <table>
              <thead id="tblHead"></thead>
              <tbody id="tblBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-head">
          <div>
            <h2>Diagnóstico rápido</h2>
            <p id="diagHint">Se um grupo não tiver histórico suficiente, o status ficará como "Sem histórico".</p>
          </div>
        </div>
        <div class="diag" id="diagBox"></div>
      </section>
    </main>

    <footer class="footer">
      <div>Igarapé Digital</div>
      <div id="buildInfo"></div>
    </footer>
  </div>

  <script src="app.js"></script>
</body>
</html>
